# Template installing all dependencies.
parameters:
  - name: artifactName
    type: string
  - name: hasPackageVariables
    type: string

steps:
  - pwsh: |
      $outDir = "$(Build.ArtifactStagingDirectory)/${{ parameters.artifactName }}"
      echo "Packing npm packages into $outDir"
      pnpm chronus pack --exclude standalone --pack-destination $outDir

      $summaryFilePath = "$outDir/publish-summary.json"
      echo "Create manifest of unpublished packages in $summaryFilePath"

      node eng/tsp-core/scripts/filter-unpublished-packages.ts "$outDir" "$outDir-unpublished" --manifest $summaryFilePath

      # Check if there are unpublished packages and set the configuration variable accordingly   
      $manifest = Get-Content $summaryFilePath | ConvertFrom-Json
      $packageCount = ($manifest.packages | Get-Member -MemberType NoteProperty).Count
      if ($packageCount -gt 0) {
        Write-Output "Found $packageCount unpublished packages to publish."
        Write-Host "##vso[task.setvariable variable=${{ parameters.hasPackageVariables }};isOutput=true]true"
      } else {
        Write-Output "No unpublished packages found."
        Write-Host "##vso[task.setvariable variable=${{ parameters.hasPackageVariables }};isOutput=true]false"
      }
    name: pack-${{ parameters.artifactName }}
    displayName: Pack packages ${{ parameters.artifactName }}
