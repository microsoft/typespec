# Template installing all dependencies.
parameters:
  - name: artifactName
    type: string
  - name: hasPackageVariables
    type: string

steps:
  - script: |
      echo "Packing npm packages into $(Build.ArtifactStagingDirectory)/${{ parameters.artifactName }}"
      pnpm chronus pack --exclude standalone --pack-destination $(Build.ArtifactStagingDirectory)/${{ parameters.artifactName }}

      echo "Create manifest of unpublished packages"
      node eng/tsp-core/scripts/filter-unpublished-packages.ts \
        "$(Pipeline.Workspace)/${{ parameters.artifactName }}" \
        --manifest "$(Build.ArtifactStagingDirectory)/${{ parameters.artifactName }}/publish-summary.json"

      # Check if there are unpublished packages and set the configuration variable accordingly   
      $manifest = Get-Content "./publish-summary.json" | ConvertFrom-Json
      $packageCount = ($manifest.packages | Get-Member -MemberType NoteProperty).Count
      if ($packageCount -gt 0) {
        Write-Output "Found $packageCount unpublished packages to publish."
        Write-Host "##vso[task.setvariable variable=${{parameters.hasPackageVariables}}]true"
      } else {
        Write-Output "No unpublished packages found."
        Write-Host "##vso[task.setvariable variable=${{parameters.hasPackageVariables}}]false"
      }
    displayName: Pack packages ${{ parameters.artifactName }}
