trigger:
  branches:
    include:
      - main
      - gh-readonly-queue/* # Used to trigger for GitHub merge queues

pr:
  - main
  - release/*

extends:
  template: /eng/pipelines/templates/1es-redirect.yml
  parameters:
    variables:
      - template: /eng/pipelines/templates/variables/globals.yml@self
    stages:
      - stage: CI
        jobs:
          - job: windows
            displayName: Windows

            variables:
              TYPESPEC_VS_CI_BUILD: true # Enable official Visual Studio extension build
              TYPESPEC_SKIP_DOCUSAURUS_BUILD: true # Disable docusaurus build

            strategy:
              matrix:
                "Node 18.x":
                  nodeVersion: 18.x

                "Node 20.x":
                  nodeVersion: 20.x

            pool:
              name: $(WINDOWSPOOL)
              image: $(WINDOWSVMIMAGE)
              os: windows

            steps:
              - template: /eng/pipelines/jobs/build-and-test.yml
                parameters:
                  nodeVersion: $(nodeVersion)
                  os: linux

          - job: linux
            displayName: Linux

            variables:
              TYPESPEC_VS_CI_BUILD: true # Enable official Visual Studio extension build
              TYPESPEC_SKIP_DOCUSAURUS_BUILD: true # Disable docusaurus build

            strategy:
              matrix:
                "Node 18.x":
                  nodeVersion: 18.x

                "Node 20.x":
                  nodeVersion: 20.x

            pool:
              name: $(LINUXPOOL)
              image: $(LINUXVMIMAGE)
              os: linux

            steps:
              - template: /eng/pipelines/jobs/build-and-test.yml
                parameters:
                  nodeVersion: $(nodeVersion)
                  os: linux

          - template: /eng/pipelines/jobs/publish-artifacts.yml
          - template: /eng/pipelines/jobs/e2e.yml

          - job: docker_build
            pool:
              name: $(LINUXPOOL)
              image: $(LINUXVMIMAGE)
              os: linux
            steps:
              - script: docker build -f ./docker/Dockerfile .
                displayName: Docker build
