# cspell:ignore azuresdkcadlranch

parameters:
  # Custom steps to run in the Build and Test stages after the repositories are cloned.
  - name: AdditionalInitializeSteps
    type: stepList
    default: []

  # Location of emitter package path
  - name: PackagePath
    type: string

  # Node version
  #  Currently not installing node in this template, but keeping this parameter for future use
  - name: NodeVersion
    type: string
    default: "20.x"

  # Arguments needed to run tests
  - name: TestArgs
    type: string

  # Language short name
  - name: LanguageShortName
    type: string

  - name: BuildArtifactName
    type: string
    default: ""

  # Emit artifacts
  - name: EmitArtifacts
    type: boolean
    default: false

  - name: CadlRanchName
    type: string
    default: ""

steps:
  - checkout: self

  - download: current
    artifact: ${{ parameters.BuildArtifactName }}
    displayName: Download build artifacts

  - ${{ parameters.AdditionalInitializeSteps }}

  - task: PowerShell@2
    displayName: "Run initialize script"
    inputs:
      pwsh: true
      filePath: $(selfRepositoryPath)${{ parameters.PackagePath }}/eng/scripts/Initialize-Repository.ps1
      arguments: -BuildArtifactsPath '$(buildArtifactsPath)'
      workingDirectory: $(selfRepositoryPath)

  - task: PowerShell@2
    displayName: "Run test script"
    inputs:
      pwsh: true
      filePath: $(selfRepositoryPath)${{ parameters.PackagePath }}/eng/scripts/Test-Packages.ps1
      arguments: ${{ parameters.TestArgs }}
      workingDirectory: $(selfRepositoryPath)

  - ${{ if eq(variables['System.TeamProject'], 'internal') }}:
      - task: AzureCLI@2
        displayName: "Upload Cadl Ranch Standard Coverage Report"
        condition: and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['System.TeamProject'], 'internal'), eq('${{ parameters.EmitArtifacts }}', true))
        inputs:
          azureSubscription: "Cadl Ranch Storage"
          scriptType: "bash"
          scriptLocation: "inlineScript"
          inlineScript: npx cadl-ranch upload-coverage --coverageFile ./generator/artifacts/coverage/cadl-ranch-coverage-${{ parameters.LanguageShortName }}-standard.json --generatorName ${{ coalesce(parameters.CadlRanchName, parameters.LanguageShortName) }} --storageAccountName azuresdkcadlranch --generatorVersion $(node -p -e "require('./package.json').version") --generatorMode standard
          workingDirectory: $(selfRepositoryPath)${{ parameters.PackagePath }}
