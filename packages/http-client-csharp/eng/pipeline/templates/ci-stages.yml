parameters:
  - name: Condition
    type: string
    default: true
  - name: DependsOn
    type: object
    default: []

stages:
  - stage: test_stage_delete
    dependsOn: []
    jobs:
      - job: test
        displayName: Test

        pool:
          name: $(LINUXPOOL)
          image: $(LINUXVMIMAGE)
          os: linux

        steps:
          - task: NodeTool@0
            displayName: Install Node.js
            retryCountOnTaskFailure: 3
            inputs:
              versionSpec: 20.x

          - script: |
              npm install -g pnpm
              pnpm setup:min
            displayName: "Install pnpm"
          - script: |
              npm install
            displayName: "Install deps"
            workingDirectory: packages/http-client-csharp
          - script: npm run build:emitter
            displayName: Build
            workingDirectory: packages/http-client-csharp

          - script: npm run test:emitter
            displayName: Test
            workingDirectory: packages/http-client-csharp

  - template: /eng/emitters/pipelines/templates/stages/emitter-stages.yml
    parameters:
      StagePrefix: CSharp
      BuildPrereleaseVersion: true
      UseTypeSpecNext: false
      Publish: "none"
      PackagePath: /packages/http-client-csharp
      EmitterPackageJsonPath: packages/http-client-csharp/package.json
      Packages:
        - name: typespec-http-client-csharp
          file: typespec-http-client-csharp-*.tgz
          type: npm
        - name: Microsoft.Generator.CSharp
          file: Microsoft.Generator.CSharp.*.nupkg
          type: nuget
        - name: Microsoft.Generator.CSharp.ClientModel
          file: Microsoft.Generator.CSharp.ClientModel.*.nupkg
          type: nuget
        - name: Microsoft.Generator.CSharp.Input
          file: Microsoft.Generator.CSharp.Input.*.nupkg
          type: nuget
        - name: Microsoft.Generator.CSharp.Customization
          file: Microsoft.Generator.CSharp.Customization.*.nupkg
          type: nuget
      UnitTestArgs: -UnitTests
      TestMatrix:
        RegenCheck:
          TestArguments: -GenerationChecks
      Condition: ${{ parameters.Condition }}
      DependsOn: ${{ parameters.DependsOn }}
      LanguageShortName: "csharp"
