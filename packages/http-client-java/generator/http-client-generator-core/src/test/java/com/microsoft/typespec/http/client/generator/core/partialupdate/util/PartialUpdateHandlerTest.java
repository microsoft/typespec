// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) AutoRest Code Generator.

package com.microsoft.typespec.http.client.generator.core.partialupdate.util;

import static com.github.javaparser.StaticJavaParser.parse;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;

import com.github.javaparser.TokenRange;
import com.github.javaparser.ast.AccessSpecifier;
import com.github.javaparser.ast.CompilationUnit;
import com.github.javaparser.ast.body.ConstructorDeclaration;
import com.github.javaparser.ast.body.InitializerDeclaration;
import com.github.javaparser.ast.modules.ModuleDeclaration;
import com.github.javaparser.ast.stmt.BlockStmt;
import java.io.IOException;
import java.net.URISyntaxException;
import java.net.URL;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

public class PartialUpdateHandlerTest {

    @Test
    public void testClassOrInterfaceFileToTestAddMemberToExistingFile() throws IOException, URISyntaxException {
        String existingFileContent = load("partialupdate/StringOperationWithAddedMemberClient.java");
        String generatedFileContent = load("partialupdate/StringOperationGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(6, compilationUnit.getTypes().get(0).getMembers().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getConstructors().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getFields().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getMethods().size());

        assertEquals(1, compilationUnit.getTypes().get(0).getMethodsByName("addedMethod").size());
        assertTrue(compilationUnit.getTypes().get(0).getFieldByName("enumsClient").isPresent());
        assertEquals(2, compilationUnit.getTypes().get(0).getConstructors().get(1).getParameters().size());

    }

    @Test
    public void testClassOrInterfaceFileToTestUpdateMethodSignatureToExistingFile()
        throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationWithUpdateMemberClient.java");
        String generatedFileContent = load("partialupdate/StringOperationGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse").size());
        assertEquals(2,
            compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse").get(0).getParameters().size());
        assertEquals("test",
            compilationUnit.getTypes()
                .get(0)
                .getMethodsByName("putNullWithResponse")
                .get(0)
                .getParameters()
                .get(1)
                .getName()
                .asString());
        assertEquals(AccessSpecifier.NONE,
            compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse").get(0).getAccessSpecifier());
    }

    @Test
    public void testClassOrInterfaceFileToTestRemoveMethodToExistingFile() throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationWithRemovedMemberGeneratedClient.java");
        String generatedFileContent = load("partialupdate/StringOperationGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        // method is re-generated again
        assertEquals(1, compilationUnit.getTypes().get(0).getMethods().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse").size());
    }

    @Test
    public void testClassOrInterfaceFileToTestSawaggerAddAPI() throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationGeneratedClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithAddedMemberGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getMethods().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethodsByName("getWhitespaceWithResponse").size());
    }

    @Test
    public void testClassOrInterfaceFileToTestGeneratedFileRemoveAPI() throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationGeneratedClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithRemovedMemberGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(0, compilationUnit.getTypes().get(0).getMethods().size());
    }

    @Test
    public void testClassOrInterfaceFileToTestGeneratedFileUpdateAPI() throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationGeneratedClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithUpdateMemberGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethods().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse").size());
        assertEquals("updateParam",
            compilationUnit.getTypes()
                .get(0)
                .getMethodsByName("putNullWithResponse")
                .get(0)
                .getParameter(1)
                .getName()
                .asString());
    }

    @Test
    public void testClassOrInterfaceFileToTestGeneratedFileUpdateAPIAndExistingFileUpdateMethod()
        throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationWithUpdateMemberClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithUpdateMemberGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethods().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse").size());
        assertEquals("test",
            compilationUnit.getTypes()
                .get(0)
                .getMethodsByName("putNullWithResponse")
                .get(0)
                .getParameter(1)
                .getName()
                .asString());
        assertEquals(AccessSpecifier.NONE,
            compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse").get(0).getAccessSpecifier());
    }

    @Test
    public void testClassOrInterfaceFileToTestGeneratedFileRemoveAPIAndExistingFileUpdateMethod()
        throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationWithUpdateMemberClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithRemovedMemberGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethods().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse").size());
        assertEquals("test",
            compilationUnit.getTypes()
                .get(0)
                .getMethodsByName("putNullWithResponse")
                .get(0)
                .getParameter(1)
                .getName()
                .asString());
    }

    @Test
    public void
        testClassOrInterfaceFileToTestWhenGeneratedFileHasSameNameButDifferentSignatureWithExistingGeneratedMethodToTestThenShouldIncludeThisSameNameMethod()
            throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/PagedGeneratedAsyncClient.java");
        String generatedFileContent = load("partialupdate/PagedGeneratedAsyncClientWithConvenienceMethod.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(4, compilationUnit.getTypes().get(0).getMembers().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getConstructors().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getFields().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getMethods().size());

        assertEquals(2, compilationUnit.getTypes().get(0).getMethodsByName("list").size());
    }

    @Test
    public void testClassOrInterfaceFileToTestWhenNoChangesAreMadeOnNextGenerationToTestThenTheFileShouldStaySame()
        throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/PagedGeneratedAsyncClientWithConvenienceMethod.java");
        String generatedFileContent = load("partialupdate/PagedGeneratedAsyncClientWithConvenienceMethod.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(4, compilationUnit.getTypes().get(0).getMembers().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getConstructors().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getFields().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getMethods().size());

        assertEquals(2, compilationUnit.getTypes().get(0).getMethodsByName("list").size());
    }

    @Test
    public void testClassOrInterfaceFileToTestVerifyGeneratedFileShouldNotContainDuplicateMethods()
        throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationWithDuplicateMethodGeneratedClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithDuplicateMethodGeneratedClient.java");

        Exception exception = assertThrows(RuntimeException.class, () -> {
            PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);
        });

        String expectedMessage = "Found duplicate methods in the generated file.";
        String actualMessage = exception.getMessage();

        assertTrue(actualMessage.contains(expectedMessage));

    }

    @Test
    public void testClassOrInterfaceFileToTestModelCustomization() throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/Model.java");
        String generatedFileContent = load("partialupdate/GeneratedModel.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(9, compilationUnit.getTypes().get(0).getMembers().size());
        assertEquals(3, compilationUnit.getTypes().get(0).getFields().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getConstructors().size());
        assertEquals(4, compilationUnit.getTypes().get(0).getMethods().size());

    }

    @Test
    public void testModuleInfoFileToTestWhenGeneratedFileEqualsExistingFileToTestThenUseGeneratedFile() {
        String existingFileContent = String.join("\n", "// Copyright (c) Microsoft Corporation. All rights reserved.",
            "// Licensed under the MIT License.", "// Code generated by Microsoft (R) AutoRest Code Generator.", "",
            "module com.azure.iot.deviceupdate {", "", "    requires transitive com.azure.core;", "",
            "    exports com.azure.iot.deviceupdate;", "}", "");
        String generatedFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n" + "// Code generated by Microsoft (R) AutoRest Code Generator.\n"
            + "\n" + "module com.azure.iot.deviceupdate {\n" + "\n" + "    requires transitive com.azure.core;\n" + "\n"
            + "    exports com.azure.iot.deviceupdate;\n" + "}\n";

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertTrue(compilationUnit.getModule().isPresent());
        assertEquals("com.azure.iot.deviceupdate", compilationUnit.getModule().get().getName().toString());
        assertEquals(2, compilationUnit.getModule().get().getDirectives().size());
    }

    @Test
    public void testModuleInfoFileToTestWhenExistingFileHasUpdatesToTestThenUseExistingFile() {
        String existingFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n" + "// Code generated by Microsoft (R) AutoRest Code Generator.\n"
            + "\n" + "\n" + "module com.azure.messaging.webpubsubnew {\n" + "    requires transitive com.azure.core;\n"
            + "\n" + "    exports com.azure.messaging.webpubsubnew;\n"
            + "    exports com.azure.messaging.webpubsubnew.models;\n" + "}";
        String generatedFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n" + "// Code generated by Microsoft (R) AutoRest Code Generator.\n"
            + "\n" + "\n" + "module com.azure.messaging.webpubsubnew {\n" + "    requires transitive com.azure.core;\n"
            + "\n" + "    exports com.azure.messaging.webpubsubnew;\n" + "}";

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertNotNull(compilationUnit.getOrphanComments());
        assertEquals(3, compilationUnit.getOrphanComments().size());
        assertTrue(compilationUnit.getModule().isPresent());
        assertEquals("com.azure.messaging.webpubsubnew", compilationUnit.getModule().get().getName().toString());
        assertEquals(3, compilationUnit.getModule().get().getDirectives().size());
    }

    @Test
    public void
        testModuleInfoFileToTestMergeExistingFileAndGeneratedFileToTestWhenExistingFileContentHasMoreDirectives() {
        String existingFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n" + "// Code generated by Microsoft (R) AutoRest Code Generator.\n"
            + "module com.azure.messaging.webpubsubnew {\n" + "    requires transitive com.azure.core;\n" + "\n"
            + "    exports com.azure.messaging.webpubsubnew;\n"
            + "    exports com.azure.messaging.webpubsubnew.models;\n" + "}";
        String generatedFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n" + "// Code generated by Microsoft (R) AutoRest Code Generator.\n"
            + "module com.azure.messaging.webpubsubnew {\n" + "    requires transitive com.azure.core;\n" + "\n"
            + "    exports com.azure.messaging.webpubsubnew;\n" + "}";
        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        ModuleDeclaration module = compilationUnit.getModule().orElseThrow();
        assertEquals("com.azure.messaging.webpubsubnew", module.getName().toString());
        assertEquals(3, module.getDirectives().size());
        assertEquals("requires transitive com.azure.core;",
            module.getDirectives().get(0).getTokenRange().map(TokenRange::toString).orElseThrow());
        assertEquals("exports com.azure.messaging.webpubsubnew;",
            module.getDirectives().get(1).getTokenRange().map(TokenRange::toString).orElseThrow());
        assertEquals("exports com.azure.messaging.webpubsubnew.models;",
            module.getDirectives().get(2).getTokenRange().map(TokenRange::toString).orElseThrow());
    }

    @Test
    public void
        testModuleInfoFileToTestMergeExistingFileAndGeneratedFileToTestWhenGeneratedFileContentHasMoreDirectives() {
        String existingFileContent
            = "module com.azure.communication.phonenumbersdemo {\n" + "    requires transitive com.azure.core;\n" + "\n"
                + "    exports com.azure.communication.phonenumbersdemo;\n" + "}";
        String generatedFileContent
            = "module com.azure.communication.phonenumbersdemo {\n" + "    requires transitive com.azure.core;\n" + "\n"
                + "    exports com.azure.communication.phonenumbersdemo;\n"
                + "    exports com.azure.communication.phonenumbersdemo.models;\n" + "\n"
                + "    opens com.azure.communication.phonenumbersdemo.implementation.models to\n"
                + "            com.azure.core,\n" + "            com.fasterxml.jackson.databind;\n"
                + "    opens com.azure.communication.phonenumbersdemo.models to\n" + "            com.azure.core,\n"
                + "            com.fasterxml.jackson.databind;\n" + "}";
        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        ModuleDeclaration module = compilationUnit.getModule().orElseThrow();
        assertEquals("com.azure.communication.phonenumbersdemo", module.getName().toString());
        assertEquals(5, module.getDirectives().size());
        assertEquals("requires transitive com.azure.core;",
            module.getDirectives().get(0).getTokenRange().map(TokenRange::toString).orElseThrow());
        assertEquals("exports com.azure.communication.phonenumbersdemo;",
            module.getDirectives().get(1).getTokenRange().map(TokenRange::toString).orElseThrow());
        assertEquals("exports com.azure.communication.phonenumbersdemo.models;",
            module.getDirectives().get(2).getTokenRange().map(TokenRange::toString).orElseThrow());
        assertEquals(
            "opens com.azure.communication.phonenumbersdemo.implementation.models to com.azure.core, com.fasterxml.jackson.databind;",
            module.getDirectives().get(3).getTokenRange().map(TokenRange::toString).orElseThrow());
        assertEquals(
            "opens com.azure.communication.phonenumbersdemo.models to com.azure.core, com.fasterxml.jackson.databind;",
            module.getDirectives().get(4).getTokenRange().map(TokenRange::toString).orElseThrow());
    }

    @Test
    public void
        testModuleInfoFileToTestMergeExistingFileAndGeneratedFileToTestWhenExistingAndGeneratedFileHasSameContent() {
        String existingFileContent
            = "module com.azure.communication.phonenumbersdemo {\n" + "    requires transitive com.azure.core;\n" + "\n"
                + "    exports com.azure.communication.phonenumbersdemo;\n"
                + "    exports com.azure.communication.phonenumbersdemo.models;\n" + "\n"
                + "    opens com.azure.communication.phonenumbersdemo.implementation.models to\n"
                + "            com.azure.core,\n" + "            com.fasterxml.jackson.databind;\n"
                + "    opens com.azure.communication.phonenumbersdemo.models to\n" + "            com.azure.core,\n"
                + "            com.fasterxml.jackson.databind;\n" + "}";
        String generatedFileContent
            = "module com.azure.communication.phonenumbersdemo {\n" + "    requires transitive com.azure.core;\n" + "\n"
                + "    exports com.azure.communication.phonenumbersdemo;\n"
                + "    exports com.azure.communication.phonenumbersdemo.models;\n" + "\n"
                + "    opens com.azure.communication.phonenumbersdemo.implementation.models to\n"
                + "            com.azure.core,\n" + "            com.fasterxml.jackson.databind;\n"
                + "    opens com.azure.communication.phonenumbersdemo.models to\n" + "            com.azure.core,\n"
                + "            com.fasterxml.jackson.databind;\n" + "}";
        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        ModuleDeclaration module = compilationUnit.getModule().orElseThrow();
        assertEquals("com.azure.communication.phonenumbersdemo", module.getName().toString());
        assertEquals(5, module.getDirectives().size());
        assertEquals("requires transitive com.azure.core;",
            module.getDirectives().get(0).getTokenRange().map(TokenRange::toString).orElseThrow());
        assertEquals("exports com.azure.communication.phonenumbersdemo;",
            module.getDirectives()
                .get(1)
                .asModuleExportsDirective()
                .getTokenRange()
                .map(TokenRange::toString)
                .orElseThrow());
        assertEquals("exports com.azure.communication.phonenumbersdemo.models;",
            module.getDirectives()
                .get(2)
                .asModuleExportsDirective()
                .getTokenRange()
                .map(TokenRange::toString)
                .orElseThrow());
        assertEquals(
            "opens com.azure.communication.phonenumbersdemo.implementation.models to com.azure.core, com.fasterxml.jackson.databind;",
            module.getDirectives()
                .get(3)
                .asModuleOpensDirective()
                .getTokenRange()
                .map(TokenRange::toString)
                .orElseThrow());
        assertEquals(
            "opens com.azure.communication.phonenumbersdemo.models to com.azure.core, com.fasterxml.jackson.databind;",
            module.getDirectives()
                .get(4)
                .asModuleOpensDirective()
                .getTokenRange()
                .map(TokenRange::toString)
                .orElseThrow());
    }

    @Test
    public void testModuleInfoFileToTestMergeExistingFileAndGeneratedFileToTestIgnoreEmptyLineAndWhiteSpace() {
        String existingFileContent
            = "module com.azure.communication.phonenumbersdemo {\n" + "    requires transitive com.azure.core;\n" + "\n"
                + "\n" + "    exports      com.azure.communication.phonenumbersdemo;     \n"
                + "    exports com.azure.communication.phonenumbersdemo.models;\n" + "\n" + "}";
        String generatedFileContent
            = "module com.azure.communication.phonenumbersdemo {\n" + "    requires transitive com.azure.core;\n" + "\n"
                + "    exports com.azure.communication.phonenumbersdemo;\n"
                + "    exports com.azure.communication.phonenumbersdemo.models;\n" + "\n" + "}";
        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        ModuleDeclaration module = compilationUnit.getModule().orElseThrow();
        assertEquals("com.azure.communication.phonenumbersdemo", module.getName().toString());
        assertEquals(3, module.getDirectives().size());
        assertEquals("requires transitive com.azure.core;",
            module.getDirectives()
                .get(0)
                .asModuleRequiresDirective()
                .getTokenRange()
                .map(TokenRange::toString)
                .orElseThrow());
        assertEquals("exports com.azure.communication.phonenumbersdemo;",
            module.getDirectives()
                .get(1)
                .asModuleExportsDirective()
                .getTokenRange()
                .map(TokenRange::toString)
                .orElseThrow());
        assertEquals("exports com.azure.communication.phonenumbersdemo.models;",
            module.getDirectives()
                .get(2)
                .asModuleExportsDirective()
                .getTokenRange()
                .map(TokenRange::toString)
                .orElseThrow());
    }

    @Test
    public void testStaticBlockOverride() throws Exception {
        String existingFileContent = load("partialupdate/ModelWithStaticBlock.java");
        String generatedFileContent = load("partialupdate/ModelWithStaticBlockGenerated.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        List<InitializerDeclaration> staticInitializerDeclaration = compilationUnit.getTypes()
            .get(0)
            .getMembers()
            .stream()
            .filter(m -> m instanceof InitializerDeclaration)
            .map(m -> (InitializerDeclaration) m)
            .filter(InitializerDeclaration::isStatic)
            .collect(Collectors.toList());
        // verify 1 block
        Assertions.assertEquals(1, staticInitializerDeclaration.size());
        // verify the block is replaced
        Assertions.assertTrue(staticInitializerDeclaration.get(0).toString().contains("// token for test"));
    }

    @Test
    public void testStaticBlockAdd() throws Exception {
        String existingFileContent = load("partialupdate/ModelWithoutStaticBlock.java");
        String generatedFileContent = load("partialupdate/ModelWithStaticBlockGenerated.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        List<InitializerDeclaration> staticInitializerDeclaration = compilationUnit.getTypes()
            .get(0)
            .getMembers()
            .stream()
            .filter(m -> m instanceof InitializerDeclaration)
            .map(m -> (InitializerDeclaration) m)
            .filter(InitializerDeclaration::isStatic)
            .collect(Collectors.toList());
        // verify 1 block
        Assertions.assertEquals(1, staticInitializerDeclaration.size());
        // also verify a few other methods is added
        Assertions.assertNotNull(compilationUnit.getTypes().get(0).getMethodsByName("serializeAsJsonMergePatch"));
        Assertions.assertNotNull(compilationUnit.getTypes().get(0).getFieldByName("jsonMergePatch"));
        Assertions.assertNotNull(compilationUnit.getTypes().get(0).getFieldByName("updatedProperties"));
    }

    @Test
    public void testStaticBlockRemove() throws Exception {
        String existingFileContent = load("partialupdate/ModelWithStaticBlock.java");
        String generatedFileContent = load("partialupdate/ModelWithoutStaticBlockGenerated.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        // Verify no static initialization blocks exist.
        assertTrue(compilationUnit.getTypes()
            .get(0)
            .getMembers()
            .stream()
            .filter(m -> m instanceof InitializerDeclaration)
            .map(m -> (InitializerDeclaration) m)
            .noneMatch(InitializerDeclaration::isStatic));
    }

    @Test
    public void testCodeFormatterOff() throws Exception {
        String existingFileContent = load("partialupdate/ModelWithCodeFormatterOff.java");
        String generatedFileContent = load("partialupdate/GeneratedModel.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        ConstructorDeclaration constructorDeclaration = compilationUnit.getTypes().get(0).getConstructors().get(1);
        Assertions.assertTrue(
            constructorDeclaration.getJavadoc().get().getDescription().toText().contains("<!-- @formatter:off -->"));
        Assertions.assertTrue(
            constructorDeclaration.getJavadoc().get().getDescription().toText().contains("<!-- @formatter:on -->"));
        BlockStmt constructorCodeBlock = (BlockStmt) constructorDeclaration.getChildNodes()
            .stream()
            .filter(node -> node instanceof BlockStmt)
            .findFirst()
            .get();
        List<String> lines
            = Arrays.stream(constructorCodeBlock.toString().split("\n")).map(String::trim).collect(Collectors.toList());
        Assertions.assertTrue(lines.contains("// @formatter:off"));
        Assertions.assertTrue(lines.contains("// @formatter:on"));
    }

    private String load(String resource) throws IOException, URISyntaxException {
        URL resourceUrl = Objects.requireNonNull(getClass().getClassLoader().getResource(resource));
        return Files.readString(Paths.get(resourceUrl.toURI()));
    }
}
