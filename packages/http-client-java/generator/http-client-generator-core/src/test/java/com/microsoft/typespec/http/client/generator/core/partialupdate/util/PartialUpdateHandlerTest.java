// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) AutoRest Code Generator.

package com.microsoft.typespec.http.client.generator.core.partialupdate.util;

import static com.github.javaparser.StaticJavaParser.parse;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;

import com.github.javaparser.TokenRange;
import com.github.javaparser.ast.AccessSpecifier;
import com.github.javaparser.ast.CompilationUnit;
import com.github.javaparser.ast.body.BodyDeclaration;
import com.github.javaparser.ast.body.ConstructorDeclaration;
import com.github.javaparser.ast.body.MethodDeclaration;
import com.github.javaparser.ast.body.TypeDeclaration;
import com.github.javaparser.ast.modules.ModuleDeclaration;
import java.io.IOException;
import java.net.URISyntaxException;
import java.net.URL;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

public class PartialUpdateHandlerTest {

    @Test
    public void testClassOrInterfaceFileToTestAddMemberToExistingFile() throws IOException, URISyntaxException {
        String existingFileContent = load("partialupdate/StringOperationWithAddedMemberClient.java");
        String generatedFileContent = load("partialupdate/StringOperationGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(6, compilationUnit.getTypes().get(0).getMembers().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getConstructors().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getFields().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getMethods().size());

        assertEquals(1, compilationUnit.getTypes().get(0).getMethodsByName("addedMethod").size());
        assertTrue(compilationUnit.getTypes().get(0).getFieldByName("enumsClient").isPresent());
        assertEquals(2, compilationUnit.getTypes().get(0).getConstructors().get(1).getParameters().size());

    }

    @Test
    public void testClassOrInterfaceFileToTestUpdateMethodSignatureToExistingFile()
        throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationWithUpdateMemberClient.java");
        String generatedFileContent = load("partialupdate/StringOperationGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        List<MethodDeclaration> methods = compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse");
        assertEquals(1, methods.size());
        MethodDeclaration method = methods.get(0);
        assertEquals(2, method.getParameters().size());
        assertEquals("test", method.getParameters().get(1).getNameAsString());
        assertEquals(AccessSpecifier.NONE, method.getAccessSpecifier());
    }

    @Test
    public void testClassOrInterfaceFileToTestRemoveMethodToExistingFile() throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationWithRemovedMemberGeneratedClient.java");
        String generatedFileContent = load("partialupdate/StringOperationGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        // method is re-generated again
        assertEquals(1, compilationUnit.getTypes().get(0).getMethods().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse").size());
    }

    @Test
    public void testClassOrInterfaceFileToTestSawaggerAddAPI() throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationGeneratedClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithAddedMemberGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getMethods().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethodsByName("getWhitespaceWithResponse").size());
    }

    @Test
    public void testClassOrInterfaceFileToTestGeneratedFileRemoveAPI() throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationGeneratedClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithRemovedMemberGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(0, compilationUnit.getTypes().get(0).getMethods().size());
    }

    @Test
    public void testClassOrInterfaceFileToTestGeneratedFileUpdateAPI() throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationGeneratedClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithUpdateMemberGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethods().size());
        List<MethodDeclaration> methods = compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse");
        assertEquals(1, methods.size());
        assertEquals("updateParam", methods.get(0).getParameter(1).getNameAsString());
    }

    @Test
    public void testClassOrInterfaceFileToTestGeneratedFileUpdateAPIAndExistingFileUpdateMethod()
        throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationWithUpdateMemberClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithUpdateMemberGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethods().size());
        List<MethodDeclaration> methods = compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse");
        assertEquals(1, methods.size());
        MethodDeclaration method = methods.get(0);
        assertEquals("test", method.getParameter(1).getNameAsString());
        assertEquals(AccessSpecifier.NONE, method.getAccessSpecifier());
    }

    @Test
    public void testClassOrInterfaceFileToTestGeneratedFileRemoveAPIAndExistingFileUpdateMethod()
        throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationWithUpdateMemberClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithRemovedMemberGeneratedClient.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(1, compilationUnit.getTypes().get(0).getMethods().size());
        List<MethodDeclaration> methods = compilationUnit.getTypes().get(0).getMethodsByName("putNullWithResponse");
        assertEquals(1, methods.size());
        assertEquals("test", methods.get(0).getParameter(1).getNameAsString());
    }

    @Test
    public void
        testClassOrInterfaceFileToTestWhenGeneratedFileHasSameNameButDifferentSignatureWithExistingGeneratedMethodToTestThenShouldIncludeThisSameNameMethod()
            throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/PagedGeneratedAsyncClient.java");
        String generatedFileContent = load("partialupdate/PagedGeneratedAsyncClientWithConvenienceMethod.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());

        TypeDeclaration<?> type = compilationUnit.getTypes().get(0);
        assertEquals(4, type.getMembers().size());
        assertEquals(1, type.getConstructors().size());
        assertEquals(1, type.getFields().size());
        assertEquals(2, type.getMethods().size());
        assertEquals(2, type.getMethodsByName("list").size());
    }

    @Test
    public void testClassOrInterfaceFileToTestWhenNoChangesAreMadeOnNextGenerationToTestThenTheFileShouldStaySame()
        throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/PagedGeneratedAsyncClientWithConvenienceMethod.java");
        String generatedFileContent = load("partialupdate/PagedGeneratedAsyncClientWithConvenienceMethod.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());

        TypeDeclaration<?> type = compilationUnit.getTypes().get(0);
        assertEquals(4, type.getMembers().size());
        assertEquals(1, type.getConstructors().size());
        assertEquals(1, type.getFields().size());
        assertEquals(2, type.getMethods().size());
        assertEquals(2, type.getMethodsByName("list").size());
    }

    @Test
    public void testClassOrInterfaceFileToTestVerifyGeneratedFileShouldNotContainDuplicateMethods()
        throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/StringOperationWithDuplicateMethodGeneratedClient.java");
        String generatedFileContent = load("partialupdate/StringOperationWithDuplicateMethodGeneratedClient.java");

        Exception exception = assertThrows(RuntimeException.class,
            () -> PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent));

        assertTrue(exception.getMessage().contains("Found duplicate methods in the generated file."));

    }

    @Test
    public void testClassOrInterfaceFileToTestModelCustomization() throws URISyntaxException, IOException {
        String existingFileContent = load("partialupdate/Model.java");
        String generatedFileContent = load("partialupdate/GeneratedModel.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        assertEquals(9, compilationUnit.getTypes().get(0).getMembers().size());
        assertEquals(3, compilationUnit.getTypes().get(0).getFields().size());
        assertEquals(2, compilationUnit.getTypes().get(0).getConstructors().size());
        assertEquals(4, compilationUnit.getTypes().get(0).getMethods().size());

    }

    @Test
    public void testModuleInfoFileToTestWhenGeneratedFileEqualsExistingFileToTestThenUseGeneratedFile() {
        String existingFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n// Code generated by Microsoft (R) AutoRest Code Generator.\n\n"
            + "module com.azure.iot.deviceupdate {\n\n    requires transitive com.azure.core;\n\n"
            + "    exports com.azure.iot.deviceupdate;\n}\n\n";
        String generatedFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n" + "// Code generated by Microsoft (R) AutoRest Code Generator.\n\n"
            + "module com.azure.iot.deviceupdate {\n\n    requires transitive com.azure.core;\n\n"
            + "    exports com.azure.iot.deviceupdate;\n}\n";

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertTrue(compilationUnit.getModule().isPresent());
        assertEquals("com.azure.iot.deviceupdate", compilationUnit.getModule().get().getName().toString());
        assertEquals(2, compilationUnit.getModule().get().getDirectives().size());
    }

    @Test
    public void testModuleInfoFileToTestWhenExistingFileHasUpdatesToTestThenUseExistingFile() {
        String existingFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n// Code generated by Microsoft (R) AutoRest Code Generator.\n\n\n"
            + "module com.azure.messaging.webpubsubnew {\n    requires transitive com.azure.core;\n\n"
            + "    exports com.azure.messaging.webpubsubnew;\n    exports com.azure.messaging.webpubsubnew.models;\n}";
        String generatedFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n// Code generated by Microsoft (R) AutoRest Code Generator.\n\n\n"
            + "module com.azure.messaging.webpubsubnew {\n    requires transitive com.azure.core;\n\n"
            + "    exports com.azure.messaging.webpubsubnew;\n}";

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertNotNull(compilationUnit.getOrphanComments());
        assertEquals(3, compilationUnit.getOrphanComments().size());
        assertTrue(compilationUnit.getModule().isPresent());
        assertEquals("com.azure.messaging.webpubsubnew", compilationUnit.getModule().get().getName().toString());
        assertEquals(3, compilationUnit.getModule().get().getDirectives().size());
    }

    @Test
    public void
        testModuleInfoFileToTestMergeExistingFileAndGeneratedFileToTestWhenExistingFileContentHasMoreDirectives() {
        String existingFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n// Code generated by Microsoft (R) AutoRest Code Generator.\n"
            + "module com.azure.messaging.webpubsubnew {\n    requires transitive com.azure.core;\n\n"
            + "    exports com.azure.messaging.webpubsubnew;\n    exports com.azure.messaging.webpubsubnew.models;\n}";
        String generatedFileContent = "// Copyright (c) Microsoft Corporation. All rights reserved.\n"
            + "// Licensed under the MIT License.\n// Code generated by Microsoft (R) AutoRest Code Generator.\n"
            + "module com.azure.messaging.webpubsubnew {\n    requires transitive com.azure.core;\n\n"
            + "    exports com.azure.messaging.webpubsubnew;\n}";
        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        ModuleDeclaration module = compilationUnit.getModule().orElseThrow();
        assertEquals("com.azure.messaging.webpubsubnew", module.getName().toString());
        assertEquals(3, module.getDirectives().size());
        assertEquals("requires transitive com.azure.core;", moduleDirectiveToString(module, 0));
        assertEquals("exports com.azure.messaging.webpubsubnew;", moduleDirectiveToString(module, 1));
        assertEquals("exports com.azure.messaging.webpubsubnew.models;", moduleDirectiveToString(module, 2));
    }

    @Test
    public void
        testModuleInfoFileToTestMergeExistingFileAndGeneratedFileToTestWhenGeneratedFileContentHasMoreDirectives() {
        String existingFileContent = "module com.azure.communication.phonenumbersdemo {\n"
            + "    requires transitive com.azure.core;\n\n    exports com.azure.communication.phonenumbersdemo;\n}";
        String generatedFileContent = "module com.azure.communication.phonenumbersdemo {\n"
            + "    requires transitive com.azure.core;\n\n    exports com.azure.communication.phonenumbersdemo;\n"
            + "    exports com.azure.communication.phonenumbersdemo.models;\n\n"
            + "    opens com.azure.communication.phonenumbersdemo.implementation.models to\n"
            + "            com.azure.core,\n            com.fasterxml.jackson.databind;\n"
            + "    opens com.azure.communication.phonenumbersdemo.models to\n            com.azure.core,\n"
            + "            com.fasterxml.jackson.databind;\n}";
        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        ModuleDeclaration module = compilationUnit.getModule().orElseThrow();
        assertEquals("com.azure.communication.phonenumbersdemo", module.getName().toString());
        assertEquals(5, module.getDirectives().size());
        assertEquals("requires transitive com.azure.core;", moduleDirectiveToString(module, 0));
        assertEquals("exports com.azure.communication.phonenumbersdemo;", moduleDirectiveToString(module, 1));
        assertEquals("exports com.azure.communication.phonenumbersdemo.models;", moduleDirectiveToString(module, 2));
        assertEquals(
            "opens com.azure.communication.phonenumbersdemo.implementation.models to com.azure.core, com.fasterxml.jackson.databind;",
            moduleDirectiveToString(module, 3));
        assertEquals(
            "opens com.azure.communication.phonenumbersdemo.models to com.azure.core, com.fasterxml.jackson.databind;",
            moduleDirectiveToString(module, 4));
    }

    @Test
    public void
        testModuleInfoFileToTestMergeExistingFileAndGeneratedFileToTestWhenExistingAndGeneratedFileHasSameContent() {
        String existingFileContent = "module com.azure.communication.phonenumbersdemo {\n"
            + "    requires transitive com.azure.core;\n\n    exports com.azure.communication.phonenumbersdemo;\n"
            + "    exports com.azure.communication.phonenumbersdemo.models;\n\n"
            + "    opens com.azure.communication.phonenumbersdemo.implementation.models to\n"
            + "            com.azure.core,\n            com.fasterxml.jackson.databind;\n"
            + "    opens com.azure.communication.phonenumbersdemo.models to\n            com.azure.core,\n"
            + "            com.fasterxml.jackson.databind;\n}";
        String generatedFileContent = "module com.azure.communication.phonenumbersdemo {\n"
            + "    requires transitive com.azure.core;\n\n    exports com.azure.communication.phonenumbersdemo;\n"
            + "    exports com.azure.communication.phonenumbersdemo.models;\n\n"
            + "    opens com.azure.communication.phonenumbersdemo.implementation.models to\n"
            + "            com.azure.core,\n            com.fasterxml.jackson.databind;\n"
            + "    opens com.azure.communication.phonenumbersdemo.models to\n            com.azure.core,\n"
            + "            com.fasterxml.jackson.databind;\n}";
        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        ModuleDeclaration module = compilationUnit.getModule().orElseThrow();
        assertEquals("com.azure.communication.phonenumbersdemo", module.getName().toString());
        assertEquals(5, module.getDirectives().size());
        assertEquals("requires transitive com.azure.core;", moduleDirectiveToString(module, 0));
        assertEquals("exports com.azure.communication.phonenumbersdemo;", moduleDirectiveToString(module, 1));
        assertEquals("exports com.azure.communication.phonenumbersdemo.models;", moduleDirectiveToString(module, 2));
        assertEquals(
            "opens com.azure.communication.phonenumbersdemo.implementation.models to com.azure.core, com.fasterxml.jackson.databind;",
            moduleDirectiveToString(module, 3));
        assertEquals(
            "opens com.azure.communication.phonenumbersdemo.models to com.azure.core, com.fasterxml.jackson.databind;",
            moduleDirectiveToString(module, 4));
    }

    @Test
    public void testModuleInfoFileToTestMergeExistingFileAndGeneratedFileToTestIgnoreEmptyLineAndWhiteSpace() {
        String existingFileContent
            = "module com.azure.communication.phonenumbersdemo {\n" + "    requires transitive com.azure.core;\n\n\n"
                + "    exports      com.azure.communication.phonenumbersdemo;     \n"
                + "    exports com.azure.communication.phonenumbersdemo.models;\n\n}";
        String generatedFileContent = "module com.azure.communication.phonenumbersdemo {\n"
            + "    requires transitive com.azure.core;\n\n    exports com.azure.communication.phonenumbersdemo;\n"
            + "    exports com.azure.communication.phonenumbersdemo.models;\n\n}";
        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        ModuleDeclaration module = compilationUnit.getModule().orElseThrow();
        assertEquals("com.azure.communication.phonenumbersdemo", module.getName().toString());
        assertEquals(3, module.getDirectives().size());
        assertEquals("requires transitive com.azure.core;", moduleDirectiveToString(module, 0));
        assertEquals("exports com.azure.communication.phonenumbersdemo;", moduleDirectiveToString(module, 1));
        assertEquals("exports com.azure.communication.phonenumbersdemo.models;", moduleDirectiveToString(module, 2));
    }

    @Test
    public void testStaticBlockOverride() throws Exception {
        String existingFileContent = load("partialupdate/ModelWithStaticBlock.java");
        String generatedFileContent = load("partialupdate/ModelWithStaticBlockGenerated.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        List<BodyDeclaration<?>> staticInitializerDeclaration = compilationUnit.getTypes()
            .get(0)
            .getMembers()
            .stream()
            .filter(m -> m.isInitializerDeclaration() && m.asInitializerDeclaration().isStatic())
            .collect(Collectors.toList());
        // verify 1 block
        Assertions.assertEquals(1, staticInitializerDeclaration.size());
        // verify the block is replaced
        Assertions.assertTrue(staticInitializerDeclaration.get(0).toString().contains("// token for test"));
    }

    @Test
    public void testStaticBlockAdd() throws Exception {
        String existingFileContent = load("partialupdate/ModelWithoutStaticBlock.java");
        String generatedFileContent = load("partialupdate/ModelWithStaticBlockGenerated.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        // verify 1 block
        assertEquals(1,
            compilationUnit.getTypes()
                .get(0)
                .getMembers()
                .stream()
                .filter(m -> m.isInitializerDeclaration() && m.asInitializerDeclaration().isStatic())
                .count());
        // also verify a few other methods is added
        Assertions.assertNotNull(compilationUnit.getTypes().get(0).getMethodsByName("serializeAsJsonMergePatch"));
        Assertions.assertNotNull(compilationUnit.getTypes().get(0).getFieldByName("jsonMergePatch"));
        Assertions.assertNotNull(compilationUnit.getTypes().get(0).getFieldByName("updatedProperties"));
    }

    @Test
    public void testStaticBlockRemove() throws Exception {
        String existingFileContent = load("partialupdate/ModelWithStaticBlock.java");
        String generatedFileContent = load("partialupdate/ModelWithoutStaticBlockGenerated.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        assertEquals(1, compilationUnit.getTypes().size());
        // Verify no static initialization blocks exist.
        assertTrue(compilationUnit.getTypes()
            .get(0)
            .getMembers()
            .stream()
            .noneMatch(m -> m.isInitializerDeclaration() && m.asInitializerDeclaration().isStatic()));
    }

    @Test
    public void testCodeFormatterOff() throws Exception {
        String existingFileContent = load("partialupdate/ModelWithCodeFormatterOff.java");
        String generatedFileContent = load("partialupdate/GeneratedModel.java");

        String output = PartialUpdateHandler.handlePartialUpdateForFile(generatedFileContent, existingFileContent);

        CompilationUnit compilationUnit = parse(output);
        ConstructorDeclaration constructorDeclaration = compilationUnit.getTypes().get(0).getConstructors().get(1);

        // Check that the Javadoc retained formatter flags.
        String javadoc = constructorDeclaration.getJavadoc().map(doc -> doc.getDescription().toText()).orElseThrow();
        Assertions.assertTrue(javadoc.contains("<!-- @formatter:off -->"));
        Assertions.assertTrue(javadoc.contains("<!-- @formatter:on -->"));

        // Check that the constructor body retained formatter flags.
        List<String> lines
            = constructorDeclaration.getBody().toString().lines().map(String::trim).collect(Collectors.toList());
        Assertions.assertTrue(lines.contains("// @formatter:off"));
        Assertions.assertTrue(lines.contains("// @formatter:on"));
    }

    private String load(String resource) throws IOException, URISyntaxException {
        URL resourceUrl = Objects.requireNonNull(getClass().getClassLoader().getResource(resource));
        return Files.readString(Paths.get(resourceUrl.toURI()));
    }

    private static String moduleDirectiveToString(ModuleDeclaration module, int index) {
        return module.getDirectives().get(index).getTokenRange().map(TokenRange::toString).orElseThrow();
    }
}
