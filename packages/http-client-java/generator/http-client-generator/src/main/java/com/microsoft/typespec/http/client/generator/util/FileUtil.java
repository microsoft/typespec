// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

package com.microsoft.typespec.http.client.generator.util;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.FileVisitResult;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.SimpleFileVisitor;
import java.nio.file.attribute.BasicFileAttributes;
import java.util.Collections;
import java.util.Set;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class FileUtil {

    private static final Logger LOGGER = LoggerFactory.getLogger(FileUtil.class);

    private FileUtil() {
    }

    /**
     * Write given content to the given file under given path.
     *
     * @param outputDir output directory, will create if not exist
     * @param fileName filename
     * @param content content to write to the file
     * @return the file
     */
    public static File writeToFile(String outputDir, String fileName, String content) {
        File outputFile = Paths.get(outputDir, fileName).toAbsolutePath().toFile();
        File parentFile = outputFile.getParentFile();
        if (!parentFile.exists()) {
            parentFile.mkdirs();
        }

        try {
            Files.writeString(outputFile.toPath(), content);
        } catch (IOException e) {
            throw new IllegalStateException(e);
        }
        return outputFile;
    }

    public static void deleteGeneratedJavaFiles(String outputDir) {
        deleteGeneratedJavaFiles(outputDir, Collections.emptySet());
    }

    public static void deleteGeneratedJavaFiles(String outputDir, Set<String> relativePathOfJavaFilesToKeep) {
        Path rootPath = Paths.get(outputDir);
        if (!Files.exists(rootPath) || !Files.isDirectory(rootPath)) {
            return;
        }

        try {
            Files.walkFileTree(rootPath, new SimpleFileVisitor<Path>() {
                @Override
                public FileVisitResult visitFile(Path filePath, BasicFileAttributes attrs) throws IOException {
                    String relativeFilePath = rootPath.relativize(filePath).toString().replace(File.separatorChar, '/');
                    if (!relativePathOfJavaFilesToKeep.contains(relativeFilePath) && isGeneratedJavaFile(filePath)) {
                        try {
                            Files.deleteIfExists(filePath);
                        } catch (IOException e) {
                            LOGGER.warn("Failed to delete generated file: {}", filePath.toAbsolutePath().toString(), e);
                        }
                    }
                    return FileVisitResult.CONTINUE;
                }

                @Override
                public FileVisitResult visitFileFailed(Path file, IOException exc) throws IOException {
                    LOGGER.warn("Failed to access file: {}", file.toAbsolutePath(), exc);
                    return FileVisitResult.CONTINUE;
                }
            });
        } catch (IOException e) {
            throw new IllegalStateException("Failed to delete generated java files under " + outputDir, e);
        }
    }

    private static boolean isGeneratedJavaFile(Path filePath) {
        if (filePath == null
            || !Files.isRegularFile(filePath)
            || !filePath.getFileName().toString().endsWith(".java")) {
            return false;
        }

        try (BufferedReader reader = Files.newBufferedReader(filePath, StandardCharsets.UTF_8)) {
            String line;
            int lines = 0;
            while ((line = reader.readLine()) != null && lines < 30) {
                String trimmedLine = line.trim();
                if (trimmedLine.equals("// Code generated by Microsoft (R) TypeSpec Code Generator.")
                    || trimmedLine.equals("// Code generated by Microsoft (R) AutoRest Code Generator.")) {
                    return true;
                }
                ++lines;
            }
        } catch (IOException e) {
            LOGGER.warn("Unable to read file when checking for generated marker: {}",
                filePath.toAbsolutePath().toString(), e);
        }

        return false;
    }

}
