// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

package com.microsoft.typespec.http.client.generator.util;

import static org.junit.jupiter.api.Assertions.*;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Set;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;

public final class FileUtilTests {

    @Test
    public void deleteGeneratedJavaFiles_deletesGeneratedFilesExceptKeptOnes(@TempDir Path tempDir) throws IOException {
        Path root = tempDir.resolve("output");
        Files.createDirectories(root);

        Path gen1 = root.resolve("Generated1.java");
        Files.writeString(gen1,
            "// Code generated by Microsoft (R) TypeSpec Code Generator.\npublic class Generated1 {}\n",
            StandardCharsets.UTF_8);

        Path subdir = root.resolve("subdir");
        Files.createDirectories(subdir);
        Path gen2 = subdir.resolve("Generated2.java");
        Files.writeString(gen2,
            "/* header */\n// Code generated by Microsoft (R) AutoRest Code Generator.\npublic class Generated2 {}\n",
            StandardCharsets.UTF_8);

        Path nonGen = root.resolve("NotGenerated.java");
        Files.writeString(nonGen, "public class NotGenerated {}\n", StandardCharsets.UTF_8);

        Path keepdir = root.resolve("keepdir");
        Files.createDirectories(keepdir);
        Path keep = keepdir.resolve("KeepMe.java");
        Files.writeString(keep, "// Code generated by Microsoft (R) TypeSpec Code Generator.\npublic class KeepMe {}\n",
            StandardCharsets.UTF_8);

        // Call method with keep set (use forward slashes for relative path)
        Set<String> keepSet = Set.of("keepdir/KeepMe.java");
        FileUtil.deleteGeneratedJavaFiles(root.toString(), keepSet);

        // Assertions
        assertFalse(Files.exists(gen1), "Generated1.java should be deleted");
        assertFalse(Files.exists(gen2), "Generated2.java in subdir should be deleted");
        assertTrue(Files.exists(nonGen), "NotGenerated.java should not be deleted");
        assertTrue(Files.exists(keep), "KeepMe.java should be kept");
    }
}
